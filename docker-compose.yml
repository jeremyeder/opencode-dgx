services:
  caddy:
    image: caddy:2-alpine
    restart: unless-stopped
    ports:
      - "443:443"
      - "80:80"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - oauth2-proxy
    networks:
      - opencode-net

  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.6.0
    restart: unless-stopped
    command:
      - --http-address=0.0.0.0:4180
      - --upstream=http://opencode:4096
      - --email-domain=${EMAIL_DOMAIN:-redhat.com}
      - --provider=google
      - --cookie-secret=${COOKIE_SECRET}
      - --cookie-secure=true
      - --cookie-samesite=lax
      - --client-id=${GOOGLE_CLIENT_ID}
      - --client-secret=${GOOGLE_CLIENT_SECRET}
      - --redirect-url=${OPENCODE_URL}/oauth2/callback
      - --skip-provider-button=true
      - --session-store-type=cookie
      - --cookie-expire=168h
      - --cookie-refresh=1h
    depends_on:
      - opencode
    networks:
      - opencode-net

  opencode:
    image: node:22-slim
    restart: unless-stopped
    working_dir: /app
    command: >
      sh -c "
        npm install -g opencode-ai@latest &&
        opencode serve --port 4096 --hostname 0.0.0.0
      "
    volumes:
      - opencode_data:/root/.opencode
      - opencode_config:/root/.config/opencode
      - ${PROJECTS_DIR:-/home}:/projects
    environment:
      - HOME=/root
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
    networks:
      - opencode-net

volumes:
  caddy_data:
  caddy_config:
  opencode_data:
  opencode_config:

networks:
  opencode-net:
    driver: bridge
